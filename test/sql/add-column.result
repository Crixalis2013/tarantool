-- test-run result file version 2
test_run = require('test_run').new()
 | ---
 | ...
engine = test_run:get_cfg('engine')
 | ---
 | ...
_ = box.space._session_settings:update('sql_default_engine', {{'=', 2, engine}})
 | ---
 | ...

--
-- gh-3075: Check <ALTER TABLE table ADD COLUMN column> statement.
--
box.execute('CREATE TABLE t1 (a INTEGER PRIMARY KEY);')
 | ---
 | - row_count: 1
 | ...
--
-- COLUMN keyword is optional. Check it here, but omit it below.
--
box.execute('ALTER TABLE t1 ADD COLUMN b INTEGER;')
 | ---
 | - row_count: 0
 | ...

--
-- Can't add column to a view.
--
box.execute('CREATE VIEW v AS SELECT * FROM t1;')
 | ---
 | - row_count: 1
 | ...
box.execute('ALTER TABLE v ADD b INTEGER;')
 | ---
 | - null
 | - Can't add column 'B'. 'V' is a view
 | ...
box.execute('DROP VIEW v;')
 | ---
 | - row_count: 1
 | ...

--
-- Check column constraints typing and work.
--
box.execute('CREATE TABLE t2 (a INTEGER CONSTRAINT pk_constr PRIMARY KEY);')
 | ---
 | - row_count: 1
 | ...
box.execute('ALTER TABLE t2 DROP CONSTRAINT pk_constr')
 | ---
 | - row_count: 1
 | ...
test_run:cmd("setopt delimiter ';'");
 | ---
 | - true
 | ...
box.execute([[ALTER TABLE t2 ADD b INTEGER CONSTRAINT pk_constr PRIMARY KEY
                                   CHECK (b > 0)
                                   REFERENCES t1(a)
                                   CONSTRAINT u_constr UNIQUE]])
test_run:cmd("setopt delimiter ''");
 | ---
 | ...
box.execute('INSERT INTO t1 VALUES (1, 1);')
 | ---
 | - row_count: 1
 | ...
box.execute('INSERT INTO t2 VALUES (1, 1);')
 | ---
 | - row_count: 1
 | ...
box.execute('INSERT INTO t2 VALUES (1, 1);')
 | ---
 | - null
 | - Duplicate key exists in unique index 'PK_CONSTR' in space 'T2'
 | ...

box.execute('INSERT INTO t1 VALUES (0, 1);')
 | ---
 | - row_count: 1
 | ...
box.execute('INSERT INTO t2 VALUES (2, 0);')
 | ---
 | - null
 | - 'Check constraint failed ''ck_unnamed_T2_1'': b > 0'
 | ...

box.execute('INSERT INTO t2 VALUES (2, 3);')
 | ---
 | - null
 | - 'Failed to execute SQL statement: FOREIGN KEY constraint failed'
 | ...

box.execute('DROP TABLE t2;')
 | ---
 | - row_count: 1
 | ...

--
-- Check self-referenced FK creation.
--
box.execute('CREATE TABLE t2 (a INTEGER PRIMARY KEY);')
 | ---
 | - row_count: 1
 | ...
box.execute('ALTER TABLE t2 ADD b INT REFERENCES t1')
 | ---
 | - row_count: 0
 | ...

box.execute('DROP TABLE t2;')
 | ---
 | - row_count: 1
 | ...

--
-- Check AUTOINCREMENT work.
--
box.execute("CREATE TABLE t2(a INTEGER CONSTRAINT pk PRIMARY KEY);")
 | ---
 | - row_count: 1
 | ...
box.execute("ALTER TABLE t2 DROP CONSTRAINT pk;")
 | ---
 | - row_count: 1
 | ...
box.execute("ALTER TABLE t2 ADD b INTEGER PRIMARY KEY AUTOINCREMENT;")
 | ---
 | - row_count: 0
 | ...
box.execute("ALTER TABLE t2 ADD c INTEGER AUTOINCREMENT;")
 | ---
 | - null
 | - 'Can''t add AUTOINCREMENT: the space ''T2'' already has one auto-incremented field'
 | ...

box.execute('DROP TABLE t2;')
 | ---
 | - row_count: 1
 | ...

--
-- Check clauses after column typing and work.
--
box.execute('CREATE TABLE t2 (a INTEGER PRIMARY KEY, b INTEGER);')
 | ---
 | - row_count: 1
 | ...
test_run:cmd("setopt delimiter ';'");
 | ---
 | - true
 | ...
box.execute([[ALTER TABLE t2 ADD c TEXT NOT NULL DEFAULT ('a')
                                   COLLATE "unicode_ci";]]);
 | ---
 | - row_count: 0
 | ...
test_run:cmd("setopt delimiter ''");
 | ---
 | - true
 | ...
box.execute('INSERT INTO t2(a, b) VALUES (1, 1);')
 | ---
 | - row_count: 1
 | ...
box.execute('SELECT * FROM t2;')
 | ---
 | - metadata:
 |   - name: A
 |     type: integer
 |   - name: B
 |     type: integer
 |   - name: C
 |     type: string
 |   rows:
 |   - [1, 1, 'a']
 | ...
box.execute('INSERT INTO t2 VALUES (2, 2, NULL);')
 | ---
 | - null
 | - 'Failed to execute SQL statement: NOT NULL constraint failed: T2.C'
 | ...
box.execute('SELECT * FROM t2 WHERE c LIKE \'A\';')
 | ---
 | - metadata:
 |   - name: A
 |     type: integer
 |   - name: B
 |     type: integer
 |   - name: C
 |     type: string
 |   rows:
 |   - [1, 1, 'a']
 | ...

--
-- Try to add to a non-empty space a [non-]nullable field.
--
box.execute('ALTER TABLE t2 ADD d INTEGER;')
 | ---
 | - null
 | - Tuple field count 3 does not match space field count 4
 | ...
box.execute('ALTER TABLE t2 ADD d TEXT NOT NULL');
 | ---
 | - null
 | - Tuple field count 3 does not match space field count 4
 | ...
box.execute('ALTER TABLE t2 ADD e TEXT NULL');
 | ---
 | - null
 | - Tuple field count 3 does not match space field count 4
 | ...

--
-- Add to a space with no-SQL adjusted or without format.
--
_ = box.schema.space.create('WITHOUT')
 | ---
 | ...
box.execute("ALTER TABLE WITHOUT ADD a INTEGER;")
 | ---
 | - row_count: 0
 | ...
box.execute("DROP TABLE WITHOUT;")
 | ---
 | - row_count: 1
 | ...

s = box.schema.space.create('NOSQL')
 | ---
 | ...
s:format{{name = 'A', type = 'unsigned'}}
 | ---
 | ...
box.execute("ALTER TABLE NOSQL ADD b INTEGER")
 | ---
 | - row_count: 0
 | ...

box.execute('DROP TABLE t2;')
 | ---
 | - row_count: 1
 | ...
--
-- Add multiple columns inside a transaction.
--
box.execute('CREATE TABLE t2 (a INTEGER PRIMARY KEY)')
 | ---
 | - row_count: 1
 | ...
box.begin()                                                                     \
box.execute('ALTER TABLE t2 ADD b INT')                                         \
box.execute('ALTER TABLE t2 ADD c INT')                                         \
box.commit()
 | ---
 | ...

box.execute('INSERT INTO t2 VALUES (1, 1, 1)')
 | ---
 | - row_count: 1
 | ...
box.execute('SELECT * FROM t2;')
 | ---
 | - metadata:
 |   - name: A
 |     type: integer
 |   - name: B
 |     type: integer
 |   - name: C
 |     type: integer
 |   rows:
 |   - [1, 1, 1]
 | ...
